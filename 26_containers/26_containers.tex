\documentclass[aspectratio=169,12pt,t]{beamer}
\usepackage{graphicx}
\setbeameroption{hide notes}
\setbeamertemplate{note page}[plain]
\usepackage{listings}

\input{../LaTeX/header.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% end of header
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title{Containers for reproducibility}
\author{\href{https://kbroman.org}{Karl Broman}}
\institute{Biostatistics \& Medical Informatics, UW{\textendash}Madison}
\date{\href{https://kbroman.org}{\tt \scriptsize \color{foreground} kbroman.org}
\\[-4pt]
\href{https://github.com/kbroman}{\tt \scriptsize \color{foreground} github.com/kbroman}
\\[-4pt]
\href{https://twitter.com/kwbroman}{\tt \scriptsize \color{foreground} @kwbroman}
\\[-4pt]
{\scriptsize Course web: \href{https://kbroman.org/AdvData}{\tt kbroman.org/AdvData}}
}

\begin{document}

{
\setbeamertemplate{footline}{} % no page number here
\frame{
  \titlepage

\note{
  In this lecture, we'll look at the how to keep track of dependencies
  to further enhance reproducible research. In particular, we will
  focus on Docker containers.
}
} }





\begin{frame}[c]{Reproducible research}

\begin{quotation}
  organize the data and code in a way \\[4pt]
  that you can hand them to someone else \\[4pt]
  and they can re-run the code \\[4pt]
  and get the same results \\[4pt]
  \quad (the same figures and tables)
\end{quotation}

\note{
  A central theme of this course has been reproducible
  research: organizational strategies and tools so that your
  computational work can be reproduced.
}
\end{frame}







\begin{frame}{Dependency Hell}

\bbi
  \item What software does your project depend on?
    \bi
  \item operating system
  \item system libraries
  \item R or python
  \item packages or modules
  \item other tools (e.g. pandoc and \LaTeX)
    \ei
  \item Can you install all necessary dependencies?
  \item Have dependencies changed? Do you need particular versions?
  \item How much time does it take to set things up?
\ei

\note{
  We have not much touched on how to keep track of dependencies. This
  can be a major challenge. In some research areas, things are
  evolving rapidly. And the more tools you use, the greater chance
  that some will change over time and that things will be broken.

  Even if you don't rely on much other software, it can still be a
  huge pain for users to collect and install all of the necessary
  tools. So much so that they end up giving up.
}
\end{frame}






\begin{frame}{Capturing dependencies}

\bbi
  \item R: \href{https://rstudio.github.io/renv}{\tt renv}
    \bi
  \item[] {\tt renv::init()}
  \item[] {\tt renv::snapshot()}
  \item[] {\tt renv::restore()}
    \bigskip

  \item[] \hspace{-8mm} {\color{foreground} Also see} \href{https://mran.microsoft.com/MRAN}{MRAN}
    \ei

\bigskip

  \item Python: \href{https://docs.conda.io}{\tt conda}
    \bi
    \item[] {\tt conda create}
    \item[] {\tt conda install}
    \item[] {\tt conda activate}
    \item[] {\tt conda env list --explicit}
    \bigskip

  \item[] \hspace{-8mm} {\color{foreground} Also the built-in}
    \href{https://realpython.com/python-virtual-environments-a-primer}{\tt venv}
    \ei

\ei

\note{
   These best ways to keep track of dependencies: for R, use the renv
   package from RStudio. For python, use conda.

   Also for R, see MRAN: Microsoft is taking daily snapshots of CRAN.

   And for Python: I mention conda here, but that's really a general,
   language-agnostic solution. Also consider the built-in venv solution
   for ``virtual environments.''
}
\end{frame}




\begin{frame}{Or create package/module}

  \bbi
\item R package
  \bi
\item dependencies in {\tt DESCRIPTION} file
\item data in {\tt inst/ext\_data}
\item analyses as vignettes
  \ei
\item Python package
  \bi
\item define dependencies with {\tt setuptools.setup}
  \ei
  \ei

  \note{
    Another approach would be to make your analysis project an R
    package, identifying all of the package dependencies, including
    the data, and with the analyses included as vignettes.

    With python, it seems like you'd want to make a package, which is
    like a set of modules plus a bunch of structured information ({\tt
      \_\_init\_\_.py, setup.py}). In the setup, use {\tt
      setuptools.setup} to define dependencies.
  }

\end{frame}




\begin{frame}{Docker containers}

  \bbi
\item Light-weight virtual machine
  \bi
\item Uses the host machine's linux kernel
\item On Mac/Windows, containers run within {\tt boot2docker} VM
  \ei
\item Capture {\vhilit all} dependencies, down to the OS
\item Binary image with everything pre-installed, including data
\item Text-based recipes for creating the image
\item Can build recipe starting from some previous one
  \ei

\note{
  Docker containers are the recommended approach for fully capturing
  all aspects of one's environments, in a way that is fully portable.

  Reproducibility without the difficulties of
}

\end{frame}


\begin{frame}{Getting started with Docker}

  \bbi
\item Download and install docker, from
  \href{https://www.docker.com/products/docker-desktop}{\tt docker.com}
\item Get an account at \href{https://hub.docker.com}{\tt hub.docker.com}
  \ei

\note{
  First, install docker.

  Second, get an account at \href{https://hub.docker.com}{\tt
  hub.docker.com}, for which you can download container images, or
  upload your own.

}
\end{frame}





\begin{frame}{Docker stuff}

  \bbi
\item Container
  \bi
\item[] A running docker thing
  \ei
  \item Image
    \bi
  \item[] A binary file with a snapshot of a container
    \ei
  \item {\tt Dockerfile}
    \bi
  \item[] Text file with recipe to create a new container
    \ei
  \ei

  \note{
    A Docker container is the thing you ultimately run.

    A Docker image is a saved snapshot of a container.

    A Dockerfile is a plain text file with the recipe for creating a
    new container.
  }
\end{frame}






\begin{frame}{Rocker images}

  \bbi
\item Docker containers for R
\item Can run locally, and have RStudio in the web browser
\item Poke around:
  \bi
  \item \href{https://hub.docker.com/u/rocker}{\tt
    hub.docker.com/u/rocker}
  \item \href{https://www.rocker-project.org}{\tt rocker-project.org}
  \item \href{https://github.com/rocker-org}{\tt github.com/rocker-org}
  \ei
  \ei

\note{
  The Rocker project is an effort to create a set of Docker containers
  suitable for R users.
}

\end{frame}




\begin{frame}{Jupyter images}

  \bbi
\item Docker containers set up for Jupyter notebooks
\item Look at \href{https://hub.docker.com/u/jupyter}{jupyter}
  \ei

\note{
  You can also have a docker-based Jupyter notebook accessible in a
  browser.
}

\end{frame}








\begin{frame}[fragile,c]{Dockerfile}

\begin{lstlisting}[basicstyle=\tiny\ttfamily]
FROM java
MAINTAINER daroczig@rapporter.net

## Prepare folder for the Minecraft stuff
RUN mkdir -p /minecraft

## Download Spigot build tools
RUN wget https://hub.spigotmc.org/jenkins/job/BuildTools/[clip]/target/BuildTools.jar -P /minecraft/

## Build the Spigot server
RUN cd /minecraft && java -jar BuildTools.jar

## Symlink for the built Spigot server
RUN ln -s /minecraft/spigot*.jar /minecraft/spigot.jar

## Accept EULA
RUN echo "eula=true" > /minecraft/eula.txt

## Download and install the RaspberryJuice plugin for API access
RUN mkdir -p /minecraft/plugins \
    && wget https://github.com/zhuowei/RaspberryJuice/raw/master/jars/raspberryjuice-1.11.jar \
    && mv raspberryjuice-1.11.jar /minecraft/plugins/

## Open up API port
EXPOSE 4711
## Open up Game port
EXPOSE 25565

## Start the server
CMD cd /minecraft; java -Xms512M -Xmx1G -XX:MaxPermSize=128M -XX:+UseConcMarkSweepGC -jar spigot.jar
\end{lstlisting}

\note{
  This is the Dockerfile for a minecraft server, from the miner package.

  {\tt https://github.com/kbroman/miner/blob/master/inst/Dockerfile}

  Use {\tt docker build -t minecraft} to build it to an image named
  {\tt minecraft}.

  {\tt FROM} which takes the java image as the base for this new one

  {\tt RUN} to run a command

  {\tt EXPOSE} to open a port

  {\tt CMD} is run when the container starts
}
\end{frame}




\begin{frame}{binder}

  \bbi
\item \href{https://mybinder.org}{\tt mybinder.org}
\item add two files to a github repo $\rightarrow$ \\
  docker container in the cloud
  \bi
\item {\tt runtime.txt} telling date of R
\item {\tt install.R} with {\tt install.packages()} calls
\item special url with {\tt ?urlpath=rstudio}
  \ei
\item examples:
  \bi
\item \href{https://kbroman.org/blog/2019/02/18/omg_binder/}{\tt kbroman.org/blog/2019/02/18/omg\_binder}
\item \href{https://github.com/kbroman/Teaching_CTC2019}{\tt github.com/kbroman/Teaching\_CTC2019}
  \ei

  \ei

  \note{
    Binder is a magical tool for turning a github repository into a
    docker container running in the cloud.

    RStudio or a Jupyter notebook running in browser, with all your
    stuff ready for play.
  }
\end{frame}


\begin{frame}{Summary}

  \bbi
\item Want to capture the full environment for a project
  \bi
\item code + data
\item dependent packages, libraries
  \ei
\item Want to lower the barrier to the set-up of this stuff
\item Docker containers
  \bi
\item portable
\item shareable
\item extendable
\item {\tt Dockerfile} script to define
  \ei
\item {\tt mybinder.org}
  \bi
\item github $\rightarrow$ docker in the cloud
\item magical set-up
  \ei
  \ei

  \note{
    I always like a summary.
  }
\end{frame}

\end{document}
