\documentclass[aspectratio=169,12pt,t]{beamer}
\usepackage{graphicx}
\setbeameroption{hide notes}
\setbeamertemplate{note page}[plain]
\usepackage{listings}

\input{../LaTeX/header.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% end of header
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% title info
\title{The EM algorithm}
\subtitle{Analysis of a T cell frequency assay}
\author{\href{https://kbroman.org}{Karl Broman}}
\institute{Biostatistics \& Medical Informatics \\ UW{\textendash}Madison}
\date{\href{https://kbroman.org}{\tt \scriptsize \color{foreground} kbroman.org}
\\[-4pt]
\href{https://github.com/kbroman}{\tt \scriptsize \color{foreground} github.com/kbroman}
\\[-4pt]
\href{https://twitter.com/kwbroman}{\tt \scriptsize \color{foreground} @kwbroman}
\\[-4pt]
{\scriptsize Course web: \href{https://kbroman.org/AdvData}{\tt kbroman.org/AdvData}}
}


\begin{document}

% title slide
{
\setbeamertemplate{footline}{} % no page number here
\frame{
  \titlepage

  \note{}

} }


\begin{frame}[c]{}

  \begin{columns}[c]
    \column{0.3\textwidth}
    \fontsize{10pt}{11}\selectfont
      \bbi
      \item[\hilit Goal:] Estimate the frequency of T-cells in a blood
        sample that respond to two test antigens.

      \item[\hilit Real goal:] Determine whether a vaccine causes an
        increase in the frequency of responding T-cells.
      \ei

      \vspace{10mm}

      \hspace*{-0.2\textwidth} {\fontsize{6pt}{6}\selectfont Broman K, Speed T, Tigges M (1996)
        J Immunol Meth 198:119-132
        \href{https://doi.org/b54v33}{\tt doi.org/b54v33}}


    \column{0.5\textwidth}
        \figw{Figs/immunology.png}{1.0}

  \end{columns}


\end{frame}



\begin{frame}[c]{The assay}

  \begin{columns}[c]
    \column{0.5\textwidth}
    \fontsize{10pt}{11}\selectfont

    \bbi
  \item Combine:
    \bi
  \item diluted blood cells + growth medium
  \item antigen
  \item $^{\text{3}}$H-thymidine
    \ei

    \item Replicating cells take up $^{\text{3}}$H-thymidine.

    \item Extract the DNA and measure its radioactivity
      \ei

    \column{0.5\textwidth}
        \figw{Figs/assay.png}{1.0}

  \end{columns}

\end{frame}


\begin{frame}{Usual approaches}

  \bbi

\item Use 3 wells with antigen and 3 wells without antigen,\\
  and take the ratio of the averages

  \item Limiting dilution assay
    \bi
  \item Several dilutions of cells
  \item Many wells at each dilution
    \ei
    \ei

\end{frame}


\begin{frame}[c]{Our assay}

  \begin{columns}[c]
    \column{0.5\textwidth}
    Study a single plate or pair of plates at a single dilution.

    \column{0.5\textwidth}
    \figw{Figs/microtiter_plate.png}{1.0}


  \end{columns}


\end{frame}

\begin{frame}[c]{Data}
  \figh{Figs/lda713_data.png}{1.0}
\end{frame}


\begin{frame}[c]{Traditional analysis}
  \bbi
  \item Split wells into +/-- using a cutoff (e.g., mean + 3 SD of
    ``cells alone'' wells)
    \bi
  \item[positive =] one or more responding cells
  \item[negative =] no responding cells
    \ei

  \item Imagine that the number of responding cells in a well is
    Poisson($\lambda_i$) for group $i$

    \vspace{4mm}

  \qquad Pr(no responding cells) = $e^{-\lambda_i}$

    \vspace{4mm}

  \qquad $\hat{\lambda}_i = -\log\left(\frac{\text{\# negative wells}}{\text{\# wells}}\right)$

    \ei

\end{frame}

\begin{frame}[c]{Analysis}
  \figh{Figs/simple_method.png}{0.9}
\end{frame}



\begin{frame}{Problems}
  \bbi
\item Hard to choose cutoff
\item Potential loss of information
  \ei
\end{frame}


\begin{frame}{Response vs no. cells}
\figw{Figs/mean_response.pdf}{1.0}
\end{frame}


\begin{frame}[c]{Model}

  \vspace{3mm}

  $k_{ij}$ = Number of responding cells (unobserved)

  $y_{ij}$ = square-root of response

  \vspace{10mm}

  Assume {\hilit $k_{ij}$ $\sim \text{Poisson}(\lambda_i)$}

  \vspace{2mm}

  \hspace*{15mm} {\hilit $y_{ij}$ $|$ $k_{ij}$ $\sim \text{Normal}(a +
    b k_{ij}, \sigma)$}

  \vspace{2mm}

  \hspace*{15mm} {\hilit ($k_{ij}$, $y_{ij}$) mutually independent}

  \vspace{5mm}

  \figw{Figs/model_distribution.pdf}{1.0}

\end{frame}




\begin{frame}[c]{log Likelihood}


  \begin{eqnarray*}
    l(\boldsymbol{\lambda}, a, b, \sigma)
       & = & \sum_{i,j} \log \text{Pr}(y_{ij} | \lambda_i, a, b, \sigma) \\
    & = & \sum_{i,j} \log \left[ \sum_k
      \text{Pr}(k | \lambda_i)
      \text{Pr}(y_{ij} | k, a, b, \sigma)
      \right] \\
    & = & \sum_{i,j} \log \left[ \sum_k
      \left(\frac{e^{-\lambda_i} \lambda_i^k}{ k! }\right) \, \phi\left( \frac{y_{ij} - a -
        bk}{\sigma} \right)
      \right]
  \end{eqnarray*}

\end{frame}



\begin{frame}{EM algorithm}

\vspace{-3mm}

  \bbi
  \item Iterative algorithm useful when there is missing data that if
    observed would make things easy
  \item Dempster et al. (1977) JRSS-B 39:1-22
    \href{https://doi.org/gfxzrv}{\tt doi.org/gfxzrv}
  \item Start with some initial estimates
  \item {\hilit E-step}: expected value of missing data given current estimates
  \item {\hilit M-step}: MLEs replacing missing data with their expected values
  \item {\hilit Advantages}
    \bi
  \item often easy to code
  \item usually super stable
  \item log likelihood is non-decreasing
    \ei
    \ei

\end{frame}



\begin{frame}{This case}

  (give details of E and M step here)

\end{frame}




\begin{frame}{Oops that didn't work}

  (show log likelihood vs iterations)

\end{frame}




\begin{frame}{EM algorithm, more formally}

  get expected complete-data log likelihood given observed data

  usually a function of the sufficient statistics

  Here, we need not just $\sum k$ and $\sum k y$ but also $\sum k^2$

\end{frame}



\begin{frame}{EM algorithm, again}

  $\text{E}(k)$ and $\text{E}(k^2)$

  How to use them to get estimates of a,b,sigma

\end{frame}



\begin{frame}{Ah, now it works}

  plot of log likelihood vs iterations, again

\end{frame}


\begin{frame}{Difficulties}

\bbi
\item Starting values
\item Multiple modes
\ei

\end{frame}




\begin{frame}{Multiple modes}

(Figure with maximized log likelihood vs trials)

\end{frame}




\begin{frame}{Multiple modes}

(Table with estimates + log likelihood)

\end{frame}


\begin{frame}{Lessons}

  \bbi
\item Start with an understanding of the problem
\item Think about a model for the process
\item EM algorithm is really useful
\item Use the log likelihood as a diagnostic when implementing an EM
  algorithm
  \ei
\end{frame}



\begin{frame}{Impact}

  \bbi
\item I'm pretty sure that the vaccine they were working on didn't
  work well.
\item R package \href{https://github.com/kbroman/npem}{\tt npem}, but
  I never put it on \href{https://cran.r-project.org}{CRAN}, and no
  one has ever asked me about it.
\item Our paper has like 9 citations: no one has ever really used the
  method.
  \ei

\end{frame}


\end{document}
